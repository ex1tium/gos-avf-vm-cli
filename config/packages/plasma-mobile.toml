# Plasma Mobile Desktop Configuration
# KDE Plasma Mobile minimal tablet environment for touch-friendly operation.

[meta]
name = "plasma-mobile"
display_name = "Plasma Mobile"
description = "KDE Plasma Mobile minimal tablet environment"
type = "desktop"

[packages]
core = [
    "plasma-mobile-core",
    "plasma-settings",
    "plasma-mobile-tweaks",
    "maliit-keyboard",
    # Seat management for DRM access (required since systemd-logind doesn't work in AVF)
    "seatd",
    "libseat1",
]
optional = [
    "angelfish",
    "okular-mobile",
    "kscreen",
]
wayland_helpers = [
    "weston",
    "xwayland",
]
user_packages = []

[environment]
# Note: WAYLAND_DISPLAY is intentionally omitted - the compositor sets it dynamically at runtime
vars = [
    "XDG_SESSION_TYPE=wayland",
    "QT_QPA_PLATFORM=wayland",
    "QT_WAYLAND_DISABLE_WINDOWDECORATION=1",
    "GDK_BACKEND=wayland",
    "MOZ_ENABLE_WAYLAND=1",
    "SDL_VIDEODRIVER=wayland",
    "CLUTTER_BACKEND=wayland",
    "ECORE_EVAS_ENGINE=wayland_shm",
    "WLR_NO_HARDWARE_CURSORS=1",
    "LIBGL_ALWAYS_INDIRECT=0",
]

[files]
"~/.config/plasma-workspace/env/linuxvm-wayland.sh" = """#!/bin/sh
# Environment setup for Plasma Mobile on GrapheneOS VM
# Generated by GVM setup tool

export XDG_SESSION_TYPE=wayland
export QT_QPA_PLATFORM=wayland
export MOZ_ENABLE_WAYLAND=1
export GDK_BACKEND=wayland
export SDL_VIDEODRIVER=wayland
export WLR_NO_HARDWARE_CURSORS=1

# Ensure D-Bus session is available
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax)
fi
"""

# Wrapper script for plasmashell with mobile profile
# This is called by kwin_wayland as the session command
# Based on: https://invent.kde.org/plasma/plasma-mobile/-/blob/master/bin/startplasmamobile.in
"~/.local/bin/plasmashell-mobile" = """#!/bin/bash
# Wrapper to launch plasmashell with mobile shell
echo "plasmashell-mobile: Starting plasmashell with mobile shell..."

# The PLASMA_DEFAULT_SHELL env var tells plasmashell which shell to use
# This is set by plasma-mobile-session before calling this script
# Just run plasmashell - it will pick up the shell from environment
exec plasmashell
"""

# Custom startup script for Plasma Mobile on AVF
# Based on postmarketOS plasma-mobile startup with AVF adaptations
# See: https://wiki.postmarketos.org/wiki/Plasma_Mobile
"~/.local/bin/plasma-mobile-session" = """#!/bin/bash
# Plasma Mobile session launcher for GrapheneOS AVF
# Uses kwin_wayland directly to bypass systemd-logind dependency

echo "=== Plasma Mobile Session Launcher (AVF) ==="

# Track child PIDs for cleanup
KWIN_PID=""
DBUS_PID=""

# Cleanup function - kill all related processes
cleanup() {
    echo ""
    echo "Shutting down Plasma Mobile session..."

    # Kill plasmashell first (gracefully)
    pkill -TERM -u "$(id -u)" plasmashell 2>/dev/null

    # Kill kwin_wayland
    if [ -n "$KWIN_PID" ] && kill -0 "$KWIN_PID" 2>/dev/null; then
        kill -TERM "$KWIN_PID" 2>/dev/null
        sleep 1
        kill -KILL "$KWIN_PID" 2>/dev/null
    fi

    # Also try by name as fallback
    pkill -TERM -u "$(id -u)" kwin_wayland 2>/dev/null
    sleep 0.5
    pkill -KILL -u "$(id -u)" kwin_wayland 2>/dev/null

    # Kill dbus-daemon if we started it
    if [ -n "$DBUS_PID" ] && kill -0 "$DBUS_PID" 2>/dev/null; then
        kill -TERM "$DBUS_PID" 2>/dev/null
    fi

    echo "Plasma Mobile session ended."
    exit 0
}

# Trap signals for clean shutdown
trap cleanup INT TERM HUP QUIT EXIT

# Step 1: Set up XDG_RUNTIME_DIR BEFORE dbus-launch
if [ -z "$XDG_RUNTIME_DIR" ]; then
    export XDG_RUNTIME_DIR="/run/user/$(id -u)"
fi

echo "XDG_RUNTIME_DIR: $XDG_RUNTIME_DIR"

# Create runtime dir if it doesn't exist (with proper permissions)
if [ ! -d "$XDG_RUNTIME_DIR" ]; then
    echo "Creating XDG_RUNTIME_DIR..."
    sudo mkdir -p "$XDG_RUNTIME_DIR"
    sudo chown "$(id -u):$(id -g)" "$XDG_RUNTIME_DIR"
    sudo chmod 700 "$XDG_RUNTIME_DIR"
fi

# Step 2: Set up D-Bus session if not already available
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    echo "Starting D-Bus session..."
    eval "$(dbus-launch --sh-syntax)"
    DBUS_PID="$DBUS_DAEMON_PID"
    export DBUS_SESSION_BUS_ADDRESS
    echo "D-Bus session started: $DBUS_SESSION_BUS_ADDRESS (PID: $DBUS_PID)"
fi

# Step 3: Session type environment variables
export XDG_SESSION_TYPE=wayland
export XDG_SESSION_CLASS=user
export XDG_CURRENT_DESKTOP=KDE

# Step 4: KDE/Plasma Mobile specific environment
# From official KDE source: https://invent.kde.org/plasma/plasma-mobile/-/blob/master/bin/startplasmamobile.in
export KDE_FULL_SESSION=true
export KDE_SESSION_VERSION=6
export QT_QPA_PLATFORMTHEME=KDE
export EGL_PLATFORM=wayland
export QT_QUICK_CONTROLS_STYLE=org.kde.breeze
export QT_ENABLE_GLYPH_CACHE_WORKAROUND=1
export QT_QUICK_CONTROLS_MOBILE=true
export PLASMA_INTEGRATION_USE_PORTAL=1
export PLASMA_PLATFORM=phone:handset

# KEY: This tells plasmashell to use the mobile shell
export PLASMA_DEFAULT_SHELL=org.kde.plasma.mobileshell

# Add plasma-mobile config directory
export XDG_CONFIG_DIRS="$HOME/.config/plasma-mobile:/etc/xdg:$XDG_CONFIG_DIRS"

# Step 5: Wayland environment for Qt/GTK apps
export QT_QPA_PLATFORM=wayland
export QT_WAYLAND_DISABLE_WINDOWDECORATION=1
export GDK_BACKEND=wayland
export MOZ_ENABLE_WAYLAND=1
export SDL_VIDEODRIVER=wayland
export CLUTTER_BACKEND=wayland

# Step 6: Graphics/cursor settings for virtio-gpu
export WLR_NO_HARDWARE_CURSORS=1
export KWIN_FORCE_SW_CURSOR=1

# Give the display a moment to be ready
sleep 2

# Step 7: Verify wrapper script exists
if [ ! -x "$HOME/.local/bin/plasmashell-mobile" ]; then
    echo "ERROR: plasmashell-mobile wrapper not found or not executable!"
    echo "Run: ./gvm desktop plasma-mobile --force"
    exit 1
fi

# Step 8: Launch compositor
# DRM access requires either logind session OR seatd

# List available DRI devices
if [ -d "/dev/dri" ]; then
    echo "DRI devices found:"
    ls -la /dev/dri/
fi

# Check for existing Wayland socket from AVF host
if [ -n "$WAYLAND_DISPLAY" ] && [ -S "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]; then
    echo "Found AVF Wayland socket: $WAYLAND_DISPLAY"
    echo "Running kwin as nested compositor..."
    kwin_wayland --xwayland "$HOME/.local/bin/plasmashell-mobile" &
    KWIN_PID=$!
elif [ -d "/dev/dri" ]; then
    echo "Attempting DRM backend for display..."

    # Check if seatd is running (alternative to logind for seat management)
    if systemctl is-active --quiet seatd 2>/dev/null; then
        echo "seatd is active - using it for DRM access"
        export LIBSEAT_BACKEND=seatd
        kwin_wayland --drm --xwayland "$HOME/.local/bin/plasmashell-mobile" &
        KWIN_PID=$!
    elif pgrep -x seatd >/dev/null 2>&1; then
        echo "seatd process found - using it for DRM access"
        export LIBSEAT_BACKEND=seatd
        kwin_wayland --drm --xwayland "$HOME/.local/bin/plasmashell-mobile" &
        KWIN_PID=$!
    else
        echo ""
        echo "=========================================="
        echo "DRM access requires seat management!"
        echo ""
        echo "Since systemd-logind is not available in AVF,"
        echo "you need to install and enable seatd:"
        echo ""
        echo "  sudo apt install -y seatd libseat1"
        echo "  sudo systemctl enable --now seatd"
        echo "  sudo usermod -aG _seatd $USER"
        echo "  # Then reboot the VM"
        echo ""
        echo "After that, run: gvm start plasma-mobile"
        echo "=========================================="
        echo ""
        exit 1
    fi
else
    echo "No /dev/dri found, trying software rendering"
    export GALLIUM_DRIVER=softpipe
    export LIBGL_ALWAYS_SOFTWARE=1
    kwin_wayland --virtual --xwayland "$HOME/.local/bin/plasmashell-mobile" &
    KWIN_PID=$!
fi

echo "kwin_wayland PID: $KWIN_PID"
echo ""
echo "Press Ctrl+C to stop the session"
echo ""

# Wait for kwin to exit (or be killed by signal)
wait $KWIN_PID 2>/dev/null
EXIT_CODE=$?

# Remove EXIT trap since we're exiting normally
trap - EXIT

echo "kwin_wayland exited with code: $EXIT_CODE"
exit $EXIT_CODE
"""

[session]
# Use our custom wrapper script that handles D-Bus and bypasses systemd
# Note: requires_dbus_session is false because the script handles D-Bus internally
start_command = "~/.local/bin/plasma-mobile-session"
fallback_command = "kwin_wayland --xwayland plasmashell"
requires_dbus_session = false
helper_script_name = "start-plasma-mobile"

[conflicts]
# Plasma and Plasma Mobile share many packages but use different shells
# Having both installed is possible but may cause confusion
desktops = []
packages = []
