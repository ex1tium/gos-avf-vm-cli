# Plasma Mobile Desktop Configuration
# KDE Plasma Mobile minimal tablet environment for touch-friendly operation.

[meta]
name = "plasma-mobile"
display_name = "Plasma Mobile"
description = "KDE Plasma Mobile minimal tablet environment"
type = "desktop"

[packages]
core = [
    "plasma-mobile-core",
    "plasma-settings",
    "plasma-mobile-tweaks",
    "maliit-keyboard",
]
optional = [
    "angelfish",
    "okular-mobile",
    "kscreen",
]
wayland_helpers = [
    "weston",
    "xwayland",
]
user_packages = []

[environment]
# Note: WAYLAND_DISPLAY is intentionally omitted - the compositor sets it dynamically at runtime
vars = [
    "XDG_SESSION_TYPE=wayland",
    "QT_QPA_PLATFORM=wayland",
    "QT_WAYLAND_DISABLE_WINDOWDECORATION=1",
    "GDK_BACKEND=wayland",
    "MOZ_ENABLE_WAYLAND=1",
    "SDL_VIDEODRIVER=wayland",
    "CLUTTER_BACKEND=wayland",
    "ECORE_EVAS_ENGINE=wayland_shm",
    "WLR_NO_HARDWARE_CURSORS=1",
    "LIBGL_ALWAYS_INDIRECT=0",
]

[files]
"~/.config/plasma-workspace/env/linuxvm-wayland.sh" = """#!/bin/sh
# Environment setup for Plasma Mobile on GrapheneOS VM
# Generated by GVM setup tool

export XDG_SESSION_TYPE=wayland
export QT_QPA_PLATFORM=wayland
export MOZ_ENABLE_WAYLAND=1
export GDK_BACKEND=wayland
export SDL_VIDEODRIVER=wayland
export WLR_NO_HARDWARE_CURSORS=1

# Ensure D-Bus session is available
if [ -z "$DBUS_SESSION_BUS_ADDRESS" ]; then
    eval $(dbus-launch --sh-syntax)
fi
"""

# Custom startup script for Plasma Mobile on AVF
# This handles systemd --user session initialization
"~/.local/bin/plasma-mobile-session" = """#!/bin/bash
# Plasma Mobile session launcher for GrapheneOS AVF
# Handles systemd user session initialization

set -e

# Ensure XDG_RUNTIME_DIR exists
if [ -z "$XDG_RUNTIME_DIR" ]; then
    export XDG_RUNTIME_DIR="/run/user/$(id -u)"
fi

# Create runtime dir if it doesn't exist
if [ ! -d "$XDG_RUNTIME_DIR" ]; then
    sudo mkdir -p "$XDG_RUNTIME_DIR"
    sudo chown $(id -u):$(id -g) "$XDG_RUNTIME_DIR"
    sudo chmod 700 "$XDG_RUNTIME_DIR"
fi

# Start systemd user session if not already running
# This is required for Plasma's session management
if command -v systemctl >/dev/null 2>&1; then
    if ! systemctl --user is-active --quiet default.target 2>/dev/null; then
        echo "Starting systemd user session..."
        # Try to start systemd --user in background
        systemctl --user daemon-reload 2>/dev/null || true
        systemctl --user start default.target 2>/dev/null || true
        # Give it a moment to initialize
        sleep 1
    fi
fi

# Set session type
export XDG_SESSION_TYPE=wayland
export XDG_SESSION_CLASS=user
export XDG_CURRENT_DESKTOP=KDE

# Wayland environment
export QT_QPA_PLATFORM=wayland
export QT_WAYLAND_DISABLE_WINDOWDECORATION=1
export GDK_BACKEND=wayland
export MOZ_ENABLE_WAYLAND=1
export SDL_VIDEODRIVER=wayland
export WLR_NO_HARDWARE_CURSORS=1

# Try startplasma-wayland first, fall back to direct kwin if it fails
if command -v startplasma-wayland >/dev/null 2>&1; then
    exec startplasma-wayland
else
    # Direct fallback: run kwin_wayland with plasmashell
    exec kwin_wayland --xwayland --exit-with-session plasmashell -p org.kde.plasma.phone
fi
"""

[session]
# Use our custom wrapper script that handles systemd --user
start_command = "~/.local/bin/plasma-mobile-session"
fallback_command = "kwin_wayland --xwayland --exit-with-session plasmashell -p org.kde.plasma.phone"
requires_dbus_session = true
helper_script_name = "start-plasma-mobile"

[conflicts]
# Plasma and Plasma Mobile share many packages but use different shells
# Having both installed is possible but may cause confusion
desktops = []
packages = []
