# Plasma Mobile Desktop Configuration
# KDE Plasma Mobile minimal tablet environment for touch-friendly operation.

[meta]
name = "plasma-mobile"
display_name = "Plasma Mobile"
description = "KDE Plasma Mobile minimal tablet environment"
type = "desktop"

[packages]
core = [
    "plasma-mobile-core",
    "plasma-settings",
    "plasma-mobile-tweaks",
    "maliit-keyboard",
    # Required daemons that plasmashell needs
    "kactivitymanagerd",
    # Required for application menu (kbuildsycoca6 needs applications.menu)
    "plasma-workspace",
    "kio-extras",
    # Seat management for DRM access (required since systemd-logind doesn't work in AVF)
    "seatd",
    "libseat1",
]
optional = [
    "angelfish",
    "okular-mobile",
    "kscreen",
]
wayland_helpers = [
    "weston",
    "xwayland",
]
user_packages = []

[environment]
# Note: WAYLAND_DISPLAY is intentionally omitted - the compositor sets it dynamically at runtime
vars = [
    "XDG_SESSION_TYPE=wayland",
    "QT_QPA_PLATFORM=wayland",
    "QT_WAYLAND_DISABLE_WINDOWDECORATION=1",
    "GDK_BACKEND=wayland",
    "MOZ_ENABLE_WAYLAND=1",
    "SDL_VIDEODRIVER=wayland",
    "CLUTTER_BACKEND=wayland",
    "ECORE_EVAS_ENGINE=wayland_shm",
    "WLR_NO_HARDWARE_CURSORS=1",
    "LIBGL_ALWAYS_INDIRECT=0",
]

[files]
# Simplified Plasma Mobile session using dbus-run-session
# D-Bus activation handles kactivitymanagerd automatically
"~/.local/bin/plasma-mobile-session" = """#!/bin/bash
# Plasma Mobile session launcher for GrapheneOS AVF
# Simplified approach using dbus-run-session for proper D-Bus handling

echo "=== Plasma Mobile Session Launcher (AVF) ==="

# Set up XDG_RUNTIME_DIR if needed
if [ -z "$XDG_RUNTIME_DIR" ]; then
    export XDG_RUNTIME_DIR="/run/user/$(id -u)"
fi

if [ ! -d "$XDG_RUNTIME_DIR" ]; then
    sudo mkdir -p "$XDG_RUNTIME_DIR"
    sudo chown "$(id -u):$(id -g)" "$XDG_RUNTIME_DIR"
    sudo chmod 700 "$XDG_RUNTIME_DIR"
fi

echo "XDG_RUNTIME_DIR: $XDG_RUNTIME_DIR"

# Essential environment
export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=KDE
export KDE_FULL_SESSION=true
export KDE_SESSION_VERSION=6
export QT_QPA_PLATFORM=wayland
export QT_QUICK_CONTROLS_MOBILE=true
export PLASMA_PLATFORM=phone:handset
export WLR_NO_HARDWARE_CURSORS=1
export KWIN_FORCE_SW_CURSOR=1

# Check for AVF Wayland socket
if [ -n "$WAYLAND_DISPLAY" ] && [ -S "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]; then
    echo "Found AVF Wayland socket: $WAYLAND_DISPLAY"
    echo "Starting Plasma Mobile as nested compositor..."

    # Use dbus-run-session for proper D-Bus handling
    # D-Bus activation will start kactivitymanagerd automatically
    exec dbus-run-session kwin_wayland \\
        --socket wayland-kwin \\
        --no-lockscreen \\
        --xwayland \\
        "plasmashell -p org.kde.plasma.mobileshell"
else
    echo "No AVF Wayland socket found."
    echo "For DRM mode, seatd is required. See: ./gvm help plasma-mobile"
    exit 1
fi
"""

[session]
# Use our custom wrapper script that handles D-Bus and bypasses systemd
# Note: requires_dbus_session is false because the script handles D-Bus internally
start_command = "~/.local/bin/plasma-mobile-session"
fallback_command = "kwin_wayland --xwayland plasmashell"
requires_dbus_session = false
helper_script_name = "start-plasma-mobile"

[conflicts]
# Plasma and Plasma Mobile share many packages but use different shells
# Having both installed is possible but may cause confusion
desktops = []
packages = []
