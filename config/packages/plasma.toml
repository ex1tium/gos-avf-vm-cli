# KDE Plasma Desktop Configuration
# Full KDE Plasma desktop environment for desktop-style operation.
# This is the traditional Plasma desktop, not the mobile version.

[meta]
name = "plasma"
display_name = "KDE Plasma"
description = "Full KDE Plasma desktop environment"
type = "desktop"

[packages]
core = [
    "plasma-desktop",
    "plasma-workspace",
    "sddm",  # Display manager (disabled by gvm)
    "konsole",
    "dolphin",
    # Required daemons that plasmashell needs
    "kactivitymanagerd",
    # Seat management for DRM access (required since systemd-logind doesn't work in AVF)
    "seatd",
    "libseat1",
]
optional = [
    "firefox-esr",
    "kate",
    "kscreen",
    "plasma-nm",  # Network manager applet
    "kde-spectacle",  # Screenshot tool
]
wayland_helpers = [
    "plasma-workspace-wayland",
    "xwayland",
]
user_packages = []

[environment]
# Note: WAYLAND_DISPLAY is intentionally omitted - the compositor sets it dynamically at runtime
vars = [
    "XDG_SESSION_TYPE=wayland",
    "QT_QPA_PLATFORM=wayland",
    "QT_WAYLAND_DISABLE_WINDOWDECORATION=1",
    "GDK_BACKEND=wayland",
    "MOZ_ENABLE_WAYLAND=1",
    "SDL_VIDEODRIVER=wayland",
    "CLUTTER_BACKEND=wayland",
    "WLR_NO_HARDWARE_CURSORS=1",
    "LIBGL_ALWAYS_INDIRECT=0",
]

[files]
# Simplified Plasma session using dbus-run-session
# D-Bus activation handles kactivitymanagerd automatically
"~/.local/bin/plasma-session" = """#!/bin/bash
# KDE Plasma session launcher for GrapheneOS AVF
# Simplified approach using dbus-run-session for proper D-Bus handling

echo "=== KDE Plasma Session Launcher (AVF) ==="

# Set up XDG_RUNTIME_DIR if needed
if [ -z "$XDG_RUNTIME_DIR" ]; then
    export XDG_RUNTIME_DIR="/run/user/$(id -u)"
fi

if [ ! -d "$XDG_RUNTIME_DIR" ]; then
    sudo mkdir -p "$XDG_RUNTIME_DIR"
    sudo chown "$(id -u):$(id -g)" "$XDG_RUNTIME_DIR"
    sudo chmod 700 "$XDG_RUNTIME_DIR"
fi

echo "XDG_RUNTIME_DIR: $XDG_RUNTIME_DIR"

# Essential environment
export XDG_SESSION_TYPE=wayland
export XDG_CURRENT_DESKTOP=KDE
export KDE_FULL_SESSION=true
export KDE_SESSION_VERSION=6
export QT_QPA_PLATFORM=wayland
export WLR_NO_HARDWARE_CURSORS=1
export KWIN_FORCE_SW_CURSOR=1

# Check for AVF Wayland socket
if [ -n "$WAYLAND_DISPLAY" ] && [ -S "$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY" ]; then
    echo "Found AVF Wayland socket: $WAYLAND_DISPLAY"
    echo "Starting KDE Plasma as nested compositor..."

    # Use dbus-run-session for proper D-Bus handling
    # D-Bus activation will start kactivitymanagerd automatically
    exec dbus-run-session kwin_wayland \\
        --socket wayland-kwin \\
        --no-lockscreen \\
        --xwayland \\
        plasmashell
else
    echo "No AVF Wayland socket found."
    echo "For DRM mode, seatd is required. See: ./gvm help plasma"
    exit 1
fi
"""

[session]
# Use our custom wrapper script that handles D-Bus and bypasses systemd
# Note: requires_dbus_session is false because the script handles D-Bus internally
start_command = "~/.local/bin/plasma-session"
fallback_command = "kwin_wayland --xwayland --exit-with-session=plasmashell"
requires_dbus_session = false
helper_script_name = "start-plasma"

[conflicts]
# No hard conflicts with other desktops, but warn about disk usage
desktops = []
packages = []
