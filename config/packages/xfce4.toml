# XFCE4 Desktop Configuration
# Lightweight XFCE4 desktop environment for GrapheneOS AVF VM.
#
# XFCE4 is an X11-based desktop. On AVF's Wayland display, we use
# Xwayland to provide X11 compatibility for XFCE4 applications.
# The session starts directly without a login manager.

[meta]
name = "xfce4"
display_name = "XFCE4"
description = "Lightweight XFCE4 desktop (X11 via XWayland)"
type = "desktop"

[packages]
core = [
    "xfce4",
    "xfce4-goodies",
    "onboard",  # On-screen keyboard for touch input (AVF has no system keyboard in fullscreen)
]
optional = [
    "firefox-esr",
    "thunar",
    "xfce4-terminal",
]
wayland_helpers = [
    "xwayland",
]
user_packages = []

[environment]
# XFCE4 is X11-based - tell apps to use X11 backend
vars = [
    "XDG_SESSION_TYPE=x11",
    "GDK_BACKEND=x11",
    "QT_QPA_PLATFORM=xcb",
]

[files]
# Disable notification daemon - AVF's Wayland compositor doesn't support wlr-layer-shell
# which is required for overlay notifications
"~/.config/autostart/xfce4-notifyd.desktop" = """[Desktop Entry]
Hidden=true
"""

# Autostart on-screen keyboard (minimized to system tray)
"~/.config/autostart/onboard-autostart.desktop" = """[Desktop Entry]
Type=Application
Name=Onboard
Comment=On-screen keyboard for touch input
Exec=onboard
Icon=onboard
X-GNOME-Autostart-enabled=true
"""

# Onboard configuration for better touch experience
"~/.config/onboard/onboard.conf" = """[main]
layout=Compact
theme=Droid
show-status-icon=True
start-minimized=True
xembed-onboard=False

[window]
docking-enabled=True
docking-edge=bottom

[auto-show]
enabled=True

[typing-assistance]
auto-capitalization=True
"""

# Desktop shortcut to toggle keyboard
"~/Desktop/Keyboard.desktop" = """[Desktop Entry]
Type=Application
Name=On-Screen Keyboard
Comment=Toggle on-screen keyboard
Exec=dbus-send --type=method_call --dest=org.onboard.Onboard /org/onboard/Onboard/Keyboard org.onboard.Onboard.Keyboard.ToggleVisible
Icon=onboard
Terminal=false
Categories=Utility;Accessibility;
"""

# XFCE4 session startup script that finds an available display
"~/.local/bin/xfce4-xwayland-session" = """#!/bin/bash
# Start Xwayland with XFCE4 session
# Finds an available display number to avoid conflicts

echo "=== XFCE4 Session Launcher (AVF) ==="

# Track child PIDs for cleanup
XWAYLAND_PID=""
XFCE_PID=""

# Find an available display number
find_free_display() {
    for i in $(seq 1 10); do
        if [ ! -e "/tmp/.X${i}-lock" ] && [ ! -S "/tmp/.X11-unix/X${i}" ]; then
            echo "$i"
            return 0
        fi
    done
    echo "1"  # fallback
}

# Cleanup function - kill all related processes
cleanup() {
    echo ""
    echo "Shutting down XFCE4 session..."

    # Kill XFCE4 processes
    if [ -n "$XFCE_PID" ] && kill -0 "$XFCE_PID" 2>/dev/null; then
        kill -TERM "$XFCE_PID" 2>/dev/null
        sleep 1
        kill -KILL "$XFCE_PID" 2>/dev/null
    fi

    # Also try by name as fallback
    pkill -TERM -u "$(id -u)" xfce4-session 2>/dev/null
    sleep 0.5
    pkill -KILL -u "$(id -u)" xfce4-session 2>/dev/null

    # Kill Xwayland
    if [ -n "$XWAYLAND_PID" ] && kill -0 "$XWAYLAND_PID" 2>/dev/null; then
        kill -TERM "$XWAYLAND_PID" 2>/dev/null
        sleep 0.5
        kill -KILL "$XWAYLAND_PID" 2>/dev/null
    fi

    # Clean up lock file
    rm -f "/tmp/.X${DISPLAY_NUM}-lock" 2>/dev/null

    echo "XFCE4 session ended."
    exit 0
}

# Trap signals for clean shutdown
trap cleanup INT TERM HUP QUIT EXIT

DISPLAY_NUM=$(find_free_display)
export DISPLAY=":${DISPLAY_NUM}"

# Clean up any stale lock files for this display
rm -f "/tmp/.X${DISPLAY_NUM}-lock" 2>/dev/null

echo "Starting Xwayland on display :${DISPLAY_NUM}..."

# Start Xwayland in the background with access control disabled
Xwayland ":${DISPLAY_NUM}" -ac &
XWAYLAND_PID=$!

# Wait for Xwayland to be ready
sleep 2

# Verify Xwayland started
if ! kill -0 $XWAYLAND_PID 2>/dev/null; then
    echo "ERROR: Failed to start Xwayland"
    trap - EXIT
    exit 1
fi

echo "Xwayland PID: $XWAYLAND_PID"
echo "Starting XFCE4 on display $DISPLAY"
echo ""
echo "Press Ctrl+C to stop the session"
echo ""

# Start XFCE4 session in background so we can handle signals
startxfce4 &
XFCE_PID=$!

# Wait for XFCE to exit (or be killed by signal)
wait $XFCE_PID 2>/dev/null
EXIT_CODE=$?

# Remove EXIT trap since we're exiting normally
trap - EXIT

# Clean up Xwayland
kill -TERM "$XWAYLAND_PID" 2>/dev/null
rm -f "/tmp/.X${DISPLAY_NUM}-lock" 2>/dev/null

echo "XFCE4 exited with code: $EXIT_CODE"
exit $EXIT_CODE
"""

# Script to disable display manager on first run
"~/.local/bin/disable-display-manager" = """#!/bin/bash
# Disable any display manager that might have been installed
# This ensures we use our direct session start approach

for dm in lightdm gdm3 sddm lxdm nodm; do
    if systemctl is-enabled "$dm" 2>/dev/null | grep -q enabled; then
        echo "Disabling display manager: $dm"
        sudo systemctl disable "$dm" 2>/dev/null || true
        sudo systemctl stop "$dm" 2>/dev/null || true
    fi
done

echo "Display manager disabled. Use 'gvm start' to launch desktop."
"""

[session]
# Use the wrapper script that handles display allocation
start_command = "~/.local/bin/xfce4-xwayland-session"
fallback_command = "xfce4-session"
requires_dbus_session = true
helper_script_name = "start-xfce4"

[conflicts]
# XFCE4 uses X11 via Xwayland, which can coexist with Wayland desktops
# No hard conflicts
desktops = []
packages = []
